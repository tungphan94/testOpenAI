<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>医療受付</title>
  <style>
    :root { font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    body { margin:0; background:#fff; }
    .wrap { display:flex; flex-direction:column; height:100%; }
    .top { padding:12px 14px; border-bottom:1px solid #eee; font-weight:700; }
    .note { padding:10px 14px; background:#fff7e6; border-bottom:1px solid #ffe4b3; font-size:12px; line-height:1.35; }
    .consent { display:flex; gap:8px; align-items:flex-start; padding:10px 14px; border-bottom:1px solid #eee; font-size:12px; }
    .consent input { margin-top:2px; }
    .msgs { flex:1; overflow:auto; padding:12px; background:#fafafa; display:flex; flex-direction:column; gap:10px;}
    .row { display:flex; }
    .me { justify-content:flex-end; }
    .bot { justify-content:flex-start; }
    .bubble { max-width:82%; padding:10px 12px; border-radius:14px; border:1px solid #e9e9e9; background:#fff; white-space:pre-wrap; word-break:break-word; }
    .me .bubble { background:#e8f0ff; border-color:#d7e4ff; }
    .bar { display:flex; gap:10px; padding:12px; border-top:1px solid #eee; background:#fff; }
    textarea { flex:1; height:44px; resize:none; border-radius:12px; border:1px solid #ddd; padding:10px 12px; outline:none; }
    button { border:0; border-radius:12px; padding:0 16px; font-weight:700; cursor:pointer; background:#111; color:#fff; }
    button:disabled { opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
<div class="wrap">
  <div id="title" class="top">医療受付サポート</div>

  <div class="note">
    これは初期受付のための情報収集ツールであり、診断や治療の代替ではありません。<br/>
    呼吸困難、激しい胸痛、失神、大量出血などの危険な症状がある場合は、直ちに救急（119）へ連絡するか、最寄りの医療機関を受診してください。
  </div>

  <div class="consent">
    <input id="ck" type="checkbox">
    <label for="ck">初期受付のために情報を提供することに同意します（本ツールは医療行為ではありません）。</label>
  </div>

  <div id="msgs" class="msgs"></div>

  <div class="bar">
    <textarea id="input" placeholder="症状を入力してください（例：頭痛が3日続く）" rows="1"></textarea>
    <button id="send" disabled>送信</button>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const domain = qs.get("domain") || ""
  const tenant = qs.get("tenant") || "default";
  const title = qs.get("title") || "AIアシスタント";
  const apiBase = qs.get("apiBase") || "";
  const lang = qs.get("lang") || "ja";

  document.getElementById("title").textContent = title;

  const API_URL = (apiBase ? apiBase.replace(/\/$/,"") : "") + "/chat";

  const msgsEl = document.getElementById("msgs");
  const inputEl = document.getElementById("input");
  const sendBtn = document.getElementById("send");
  const ck = document.getElementById("ck");

  function uuidFallback() {
    // simple fallback if crypto.randomUUID not available
    return "sid_" + Math.random().toString(16).slice(2) + "_" + Date.now();
  }
  
  const SESSION_KEY = `med_widget_sid_${tenant}`;

  function getConversationId() {
    let cid = sessionStorage.getItem(SESSION_KEY);
    if (!cid) {
      cid = crypto.randomUUID();
      sessionStorage.setItem(SESSION_KEY, cid);
    }
    return cid;
  }

  const sessionId = getConversationId();

  ck.addEventListener("change", () => {
    sendBtn.disabled = !ck.checked;
    inputEl.disabled = !ck.checked;
    if (ck.checked) inputEl.focus();
  });

  function addMsg(role, text) {
    const row = document.createElement("div");
    row.className = "row " + (role === "me" ? "me" : "bot");
    const b = document.createElement("div");
    b.className = "bubble";
    b.textContent = text;
    row.appendChild(b);
    msgsEl.appendChild(row);
    msgsEl.scrollTop = msgsEl.scrollHeight;
    return row;
  }

  function autoResize() {
    inputEl.style.height = "44px";
    inputEl.style.height = Math.min(inputEl.scrollHeight, 140) + "px";
  }

  async function sendMessage() {
    const text = inputEl.value.trim();
    if (!text) return;

    addMsg("me", text);
    inputEl.value = "";
    autoResize();
    sendBtn.disabled = true;
    const ph = addMsg("bot", "…");
    try {
      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          domain: domain,
          tenant_id: tenant,
          conversation_id: sessionId,
          message: text,
        })
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const replyText = data.message ?? JSON.stringify(data);
      ph.querySelector(".bubble").textContent = replyText;
    } catch (e) {
      ph.querySelector(".bubble").textContent = "API呼び出しエラー: " + (e?.message || String(e));
    } finally {
      sendBtn.disabled = !ck.checked;
      inputEl.focus();
      msgsEl.scrollTop = msgsEl.scrollHeight;
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
  inputEl.addEventListener("input", autoResize);

  addMsg("bot", "こんにちは。症状や困っていることを教えてください。");
</script>
</body>
</html>
